<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OSINT Monitor // Global Intelligence Map</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
:root {
  --bg:         #060a0f;
  --panel:      #0b1117;
  --border:     #1a2a3a;
  --border-glow:#1e4060;
  --accent:     #00d4ff;
  --accent3:    #ffaa00;
  --accent4:    #44ff88;
  --text:       #c8d8e8;
  --text-dim:   #5a7a8a;
  --conflict:   #ff3333;
  --disaster:   #ff8800;
  --politics:   #8855ff;
  --breaking:   #ff0055;
  --general:    #00aaff;
  --font-mono:  'Share Tech Mono', monospace;
  --font-ui:    'Rajdhani', sans-serif;
  --font-body:  'Exo 2', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

/* Header */
header { height: 52px; background: var(--panel); border-bottom: 1px solid var(--border-glow); display: flex; align-items: center; padding: 0 16px; gap: 20px; flex-shrink: 0; z-index: 1000; }
.logo { font-family: var(--font-mono); font-size: 13px; color: var(--accent); letter-spacing: 3px; display: flex; align-items: center; gap: 8px; }
.logo::before { content:''; display:inline-block; width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 8px var(--accent); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 8px var(--accent)}50%{opacity:.4;box-shadow:0 0 2px var(--accent)} }
.header-stats { display:flex; gap:20px; margin-left:auto; }
.stat-pill { font-family:var(--font-mono); font-size:11px; padding:3px 10px; border:1px solid var(--border); border-radius:2px; color:var(--text-dim); display:flex; align-items:center; gap:6px; }
.stat-pill span { color:var(--accent); font-weight:bold; }
.clock { font-family:var(--font-mono); font-size:12px; color:var(--text-dim); letter-spacing:1px; }
.refresh-btn { background:transparent; border:1px solid var(--border-glow); color:var(--accent); font-family:var(--font-mono); font-size:10px; padding:5px 12px; cursor:pointer; letter-spacing:2px; transition:all .2s; }
.refresh-btn:hover { background:rgba(0,212,255,.1); border-color:var(--accent); }

/* Layout */
.main { display:flex; flex:1; overflow:hidden; }

/* Left sidebar */
.sidebar-left { width:280px; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; flex-shrink:0; }
.sidebar-section { padding:12px; border-bottom:1px solid var(--border); }
.section-label { font-family:var(--font-mono); font-size:9px; letter-spacing:3px; color:var(--text-dim); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.section-label::after { content:''; flex:1; height:1px; background:var(--border); }

/* View mode */
.view-mode-toggle { display:flex; gap:4px; }
.mode-btn { flex:1; text-align:center; font-family:var(--font-mono); font-size:10px; letter-spacing:1px; padding:7px 4px; border:1px solid var(--border); cursor:pointer; color:var(--text-dim); transition:all .15s; border-radius:2px; }
.mode-btn:hover { border-color:var(--border-glow); color:var(--text); }
.mode-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(0,212,255,.07); }

/* Topic list */
.topic-list { display:flex; flex-direction:column; gap:3px; }
.topic-item { display:flex; align-items:center; gap:8px; padding:8px; border:1px solid transparent; border-radius:2px; cursor:pointer; transition:all .15s; }
.topic-item:hover { border-color:var(--border); background:rgba(255,255,255,.02); }
.topic-item.active { border-color:var(--accent); background:rgba(0,212,255,.06); }
.topic-icon { font-size:15px; width:20px; text-align:center; }
.topic-label { font-family:var(--font-mono); font-size:10px; letter-spacing:1px; color:var(--text-dim); flex:1; line-height:1.3; }
.topic-item.active .topic-label { color:var(--text); }
.topic-count { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); background:var(--bg); padding:1px 6px; border-radius:2px; min-width:26px; text-align:center; }
.topic-item.active .topic-count { color:var(--accent); }

/* Region filters */
.filter-group { display:flex; flex-direction:column; gap:6px; }
.filter-row { display:flex; align-items:center; justify-content:space-between; font-size:12px; font-family:var(--font-ui); font-weight:500; }
.filter-row label { color:var(--text-dim); }
select { background:var(--bg); border:1px solid var(--border); color:var(--text); font-family:var(--font-mono); font-size:11px; padding:3px 6px; outline:none; cursor:pointer; }
select:focus { border-color:var(--accent); }
.toggle-row { display:flex; align-items:center; gap:8px; cursor:pointer; }
.toggle { width:28px; height:14px; background:var(--bg); border:1px solid var(--border); border-radius:7px; position:relative; transition:background .2s; }
.toggle.on { background:rgba(0,212,255,.2); border-color:var(--accent); }
.toggle::after { content:''; position:absolute; top:1px; left:1px; width:10px; height:10px; border-radius:50%; background:var(--text-dim); transition:all .2s; }
.toggle.on::after { left:15px; background:var(--accent); }

/* Legend */
.legend { display:flex; flex-direction:column; gap:6px; }
.legend-item { display:flex; align-items:center; gap:8px; font-size:11px; font-family:var(--font-ui); color:var(--text-dim); }
.legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; box-shadow:0 0 6px currentColor; }

/* Accounts */
.accounts-list { display:flex; flex-direction:column; gap:4px; overflow-y:auto; max-height:160px; }
.account-item { display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border:1px solid transparent; cursor:pointer; transition:all .15s; border-radius:2px; }
.account-item:hover { border-color:var(--border); background:rgba(255,255,255,.03); }
.account-item.active { border-color:var(--accent); background:rgba(0,212,255,.05); }
.account-handle { font-family:var(--font-mono); font-size:11px; color:var(--accent); }
.account-count { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); background:var(--bg); padding:1px 5px; border-radius:2px; }

/* Map */
#map { flex:1; position:relative; z-index:1; }
.leaflet-container { background:#040810; }
.leaflet-tile { filter:brightness(.8) saturate(.6) hue-rotate(180deg); }
.leaflet-popup-content-wrapper { background:var(--panel); border:1px solid var(--border-glow); border-radius:2px; box-shadow:0 4px 20px rgba(0,0,0,.8); color:var(--text); max-width:340px; }
.leaflet-popup-tip { background:var(--border-glow); }
.leaflet-popup-content { margin:0; }
.popup-content { padding:12px 14px; font-family:var(--font-body); }
.popup-source { font-family:var(--font-mono); font-size:9px; color:var(--text-dim); letter-spacing:2px; text-transform:uppercase; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
.popup-category { font-size:9px; font-family:var(--font-mono); padding:2px 6px; border-radius:1px; text-transform:uppercase; letter-spacing:1px; }
.popup-category.conflict{color:var(--conflict);border:1px solid var(--conflict)}
.popup-category.disaster{color:var(--disaster);border:1px solid var(--disaster)}
.popup-category.politics{color:var(--politics);border:1px solid var(--politics)}
.popup-category.breaking{color:var(--breaking);border:1px solid var(--breaking)}
.popup-category.general{color:var(--general);border:1px solid var(--general)}
.popup-title { font-family:var(--font-ui); font-weight:600; font-size:13px; line-height:1.4; margin-bottom:6px; color:#e8f4ff; }
.popup-summary { font-size:11px; color:var(--text-dim); line-height:1.5; margin-bottom:8px; }
.popup-media img { width:100%; border-radius:2px; margin-bottom:8px; border:1px solid var(--border); }
.popup-footer { display:flex; justify-content:space-between; align-items:center; }
.popup-time { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); }
.popup-link { font-family:var(--font-mono); font-size:10px; color:var(--accent); text-decoration:none; letter-spacing:1px; border-bottom:1px solid rgba(0,212,255,.3); }
.popup-link:hover { color:#fff; }
.breaking-badge { font-family:var(--font-mono); font-size:9px; color:var(--breaking); border:1px solid var(--breaking); padding:1px 6px; letter-spacing:2px; display:inline-block; margin-bottom:6px; animation:blink 1s step-end infinite; }
@keyframes blink { 50%{opacity:0} }

/* Topic tags in popup */
.topic-tags { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px; }
.topic-tag { font-family:var(--font-mono); font-size:8px; padding:1px 5px; border-radius:1px; letter-spacing:1px; text-transform:uppercase; border:1px solid var(--border); color:var(--text-dim); }
.topic-tag.war                   { color:#ff4444; border-color:#ff4444; background:rgba(255,68,68,.08); }
.topic-tag.protests              { color:#ffaa00; border-color:#ffaa00; background:rgba(255,170,0,.08); }
.topic-tag.christian_persecution { color:#88aaff; border-color:#88aaff; background:rgba(136,170,255,.08); }
.topic-tag.terrorism             { color:#ff6600; border-color:#ff6600; background:rgba(255,102,0,.08); }
.topic-tag.natural_disasters     { color:#00ccaa; border-color:#00ccaa; background:rgba(0,204,170,.08); }

/* Right sidebar */
.sidebar-right { width:300px; background:var(--panel); border-left:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; flex-shrink:0; }
.feed-header { padding:10px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.feed-tabs { display:flex; gap:2px; }
.feed-tab { font-family:var(--font-mono); font-size:10px; letter-spacing:1px; padding:4px 10px; cursor:pointer; border:1px solid transparent; color:var(--text-dim); transition:all .15s; }
.feed-tab.active { color:var(--accent); border-color:var(--accent); background:rgba(0,212,255,.06); }
.feed-count { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); }
.feed-topic-header { padding:6px 12px; border-bottom:1px solid var(--border); font-family:var(--font-mono); font-size:10px; color:var(--accent); letter-spacing:2px; display:none; }
.feed-topic-header.visible { display:block; }
.feed-list { flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.feed-item { padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; transition:background .15s; }
.feed-item:hover { background:rgba(255,255,255,.02); }
.feed-item.breaking-item { border-left:2px solid var(--breaking); }
.feed-item-source { font-family:var(--font-mono); font-size:9px; color:var(--text-dim); letter-spacing:1px; margin-bottom:4px; display:flex; justify-content:space-between; }
.feed-item-title { font-family:var(--font-ui); font-size:12px; font-weight:500; line-height:1.4; color:var(--text); margin-bottom:4px; }
.feed-item-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.cat-tag { font-family:var(--font-mono); font-size:8px; padding:1px 4px; letter-spacing:1px; text-transform:uppercase; border-radius:1px; }
.cat-tag.conflict{color:var(--conflict);background:rgba(255,51,51,.1)}
.cat-tag.disaster{color:var(--disaster);background:rgba(255,136,0,.1)}
.cat-tag.politics{color:var(--politics);background:rgba(136,85,255,.1)}
.cat-tag.breaking{color:var(--breaking);background:rgba(255,0,85,.1)}
.cat-tag.general{color:var(--general);background:rgba(0,170,255,.1)}
.sev-dots { display:flex; gap:2px; }
.sev-dot { width:5px; height:5px; border-radius:50%; background:var(--border); }
.sev-dot.filled { background:var(--accent3); }
.tweet-text { font-family:var(--font-body); font-size:11px; color:var(--text-dim); line-height:1.4; }
.tweet-handle { font-family:var(--font-mono); font-size:10px; color:var(--accent); }
.tweet-media { margin-top:6px; }
.tweet-media img { width:100%; border-radius:2px; border:1px solid var(--border); max-height:120px; object-fit:cover; }

/* Scanline */
body::after { content:''; position:fixed; inset:0; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px); pointer-events:none; z-index:9999; }

/* Corner decos */
.corner-deco { position:fixed; width:30px; height:30px; border-color:var(--border-glow); border-style:solid; z-index:9998; pointer-events:none; }
.corner-deco.tl { top:54px; left:282px; border-width:2px 0 0 2px; }
.corner-deco.tr { top:54px; right:302px; border-width:2px 2px 0 0; }
.corner-deco.bl { bottom:2px; left:282px; border-width:0 0 2px 2px; }
.corner-deco.br { bottom:2px; right:302px; border-width:0 2px 2px 0; }

/* Loading */
#loading { position:fixed; inset:0; background:var(--bg); z-index:9000; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; transition:opacity .5s; }
#loading.hidden { opacity:0; pointer-events:none; }
.loading-text { font-family:var(--font-mono); font-size:13px; color:var(--accent); letter-spacing:4px; }
.loading-bar { width:240px; height:2px; background:var(--border); position:relative; overflow:hidden; }
.loading-bar::after { content:''; position:absolute; top:0; left:-100%; width:60%; height:100%; background:linear-gradient(90deg,transparent,var(--accent),transparent); animation:slide 1.5s infinite; }
@keyframes slide { to{left:150%} }
.empty-state { padding:30px 20px; text-align:center; font-family:var(--font-mono); font-size:11px; color:var(--text-dim); letter-spacing:2px; }
</style>
</head>
<body>

<div id="loading">
  <div class="loading-text">‚ñ∂ OSINT MONITOR // INITIALIZING</div>
  <div class="loading-bar"></div>
  <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);letter-spacing:2px" id="loading-status">CONNECTING TO DATA SOURCES...</div>
</div>

<div class="corner-deco tl"></div>
<div class="corner-deco tr"></div>
<div class="corner-deco bl"></div>
<div class="corner-deco br"></div>

<header>
  <div class="logo">OSINT MONITOR // GLOBAL INTEL MAP</div>
  <div class="header-stats">
    <div class="stat-pill">EVENTS <span id="stat-events">‚Äî</span></div>
    <div class="stat-pill">BREAKING <span id="stat-breaking">‚Äî</span></div>
    <div class="stat-pill">OSINT TWEETS <span id="stat-tweets">‚Äî</span></div>
  </div>
  <div class="clock" id="clock">‚Äî</div>
  <button class="refresh-btn" onclick="triggerRefresh()">‚Üª REFRESH</button>
</header>

<div class="main">

  <div class="sidebar-left">

    <!-- VIEW MODE TOGGLE -->
    <div class="sidebar-section">
      <div class="section-label">View Mode</div>
      <div class="view-mode-toggle">
        <div class="mode-btn active" id="mode-region" onclick="setViewMode('region')">üåç REGION</div>
        <div class="mode-btn" id="mode-topic" onclick="setViewMode('topic')">üìã TOPIC</div>
      </div>
    </div>

    <!-- TOPIC PANEL -->
    <div class="sidebar-section" id="topic-panel" style="display:none">
      <div class="section-label">Topics</div>
      <div class="topic-list">
        <div class="topic-item active" id="topic-all" onclick="setTopic(null)">
          <span class="topic-icon">üåê</span>
          <span class="topic-label">ALL TOPICS</span>
          <span class="topic-count" id="tcount-all">‚Äî</span>
        </div>
        <div class="topic-item" id="topic-war" onclick="setTopic('war')">
          <span class="topic-icon">‚öî</span>
          <span class="topic-label">WAR</span>
          <span class="topic-count" id="tcount-war">‚Äî</span>
        </div>
        <div class="topic-item" id="topic-protests" onclick="setTopic('protests')">
          <span class="topic-icon">‚úä</span>
          <span class="topic-label">PROTESTS & RIOTS</span>
          <span class="topic-count" id="tcount-protests">‚Äî</span>
        </div>
        <div class="topic-item" id="topic-christian_persecution" onclick="setTopic('christian_persecution')">
          <span class="topic-icon">‚úù</span>
          <span class="topic-label">CHRISTIAN PERSECUTION</span>
          <span class="topic-count" id="tcount-christian_persecution">‚Äî</span>
        </div>
        <div class="topic-item" id="topic-terrorism" onclick="setTopic('terrorism')">
          <span class="topic-icon">üí•</span>
          <span class="topic-label">TERRORISM</span>
          <span class="topic-count" id="tcount-terrorism">‚Äî</span>
        </div>
        <div class="topic-item" id="topic-natural_disasters" onclick="setTopic('natural_disasters')">
          <span class="topic-icon">üåä</span>
          <span class="topic-label">NATURAL DISASTERS</span>
          <span class="topic-count" id="tcount-natural_disasters">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- REGION PANEL -->
    <div class="sidebar-section" id="region-panel">
      <div class="section-label">Filters</div>
      <div class="filter-group">
        <div class="filter-row">
          <label>Category</label>
          <select id="filter-category" onchange="applyFilters()">
            <option value="">ALL</option>
            <option value="breaking">BREAKING</option>
            <option value="conflict">CONFLICT</option>
            <option value="disaster">DISASTER</option>
            <option value="politics">POLITICS</option>
            <option value="general">GENERAL</option>
          </select>
        </div>
        <div class="filter-row">
          <label>Min Severity</label>
          <select id="filter-severity" onchange="applyFilters()">
            <option value="1">1+</option>
            <option value="2">2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
            <option value="5">5 only</option>
          </select>
        </div>
        <div class="filter-row">
          <label>Time Window</label>
          <select id="filter-hours" onchange="fetchData()">
            <option value="1">1 hr</option>
            <option value="3">3 hrs</option>
            <option value="6" selected>6 hrs</option>
            <option value="12">12 hrs</option>
            <option value="24">24 hrs</option>
          </select>
        </div>
        <div class="toggle-row" onclick="toggleBreaking()">
          <div class="toggle" id="breaking-toggle"></div>
          <span style="font-family:var(--font-ui);font-size:12px;color:var(--text-dim)">Breaking only</span>
        </div>
      </div>
    </div>

    <!-- LEGEND -->
    <div class="sidebar-section">
      <div class="section-label">Legend</div>
      <div class="legend" id="legend-content"></div>
      <div id="legend-note" style="margin-top:8px;font-family:var(--font-mono);font-size:9px;color:var(--text-dim);letter-spacing:1px">CIRCLE SIZE = SEVERITY LEVEL</div>
    </div>

    <!-- OSINT ACCOUNTS -->
    <div class="sidebar-section" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="section-label">OSINT Accounts</div>
      <div class="accounts-list" id="accounts-list">
        <div class="empty-state">LOADING...</div>
      </div>
    </div>

  </div>

  <div id="map"></div>

  <div class="sidebar-right">
    <div class="feed-header">
      <div class="feed-tabs">
        <div class="feed-tab active" id="tab-news" onclick="switchTab('news')">NEWS</div>
        <div class="feed-tab" id="tab-osint" onclick="switchTab('osint')">OSINT</div>
      </div>
      <div class="feed-count" id="feed-count">0 items</div>
    </div>
    <div class="feed-topic-header" id="feed-topic-header"></div>
    <div class="feed-list" id="feed-list">
      <div class="empty-state">AWAITING DATA FEED...</div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:8000' : '/api';

const TOPICS = {
  war:                   { label:'War',                   icon:'‚öî',  color:'#ff4444' },
  protests:              { label:'Protests & Riots',      icon:'‚úä', color:'#ffaa00' },
  christian_persecution: { label:'Christian Persecution', icon:'‚úù',  color:'#88aaff' },
  terrorism:             { label:'Terrorism',             icon:'üí•', color:'#ff6600' },
  natural_disasters:     { label:'Natural Disasters',     icon:'üåä', color:'#00ccaa' },
};

const CAT_COLORS = { breaking:'#ff0055', conflict:'#ff3333', disaster:'#ff8800', politics:'#8855ff', general:'#00aaff' };

let allEvents=[], allTweets=[], activeTab='news', viewMode='region', activeTopic=null, breakingOnly=false, selectedAccount=null;
let map, eventLayer, tweetLayer;

function initMap() {
  map = L.map('map',{center:[20,10],zoom:2.5,zoomControl:true,attributionControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);
  eventLayer = L.markerClusterGroup({
    maxClusterRadius:40,
    iconCreateFunction:(c)=>L.divIcon({
      html:`<div style="background:rgba(0,212,255,.15);border:1px solid rgba(0,212,255,.5);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:11px;color:#00d4ff">${c.getChildCount()}</div>`,
      className:'',iconSize:[36,36]
    })
  });
  tweetLayer = L.layerGroup();
  map.addLayer(eventLayer);
  map.addLayer(tweetLayer);
}

function timeAgo(iso) {
  const d=(Date.now()-new Date(iso).getTime())/1000;
  if(d<60) return `${Math.floor(d)}s ago`;
  if(d<3600) return `${Math.floor(d/60)}m ago`;
  return `${Math.floor(d/3600)}h ago`;
}

function markerColor(e) {
  if(viewMode==='topic') {
    const t=(e.topics||[])[0];
    return t&&TOPICS[t]?TOPICS[t].color:CAT_COLORS[e.category]||CAT_COLORS.general;
  }
  if(e.is_breaking) return CAT_COLORS.breaking;
  return CAT_COLORS[e.category]||CAT_COLORS.general;
}

function topicTagsHtml(topics) {
  if(!topics||!topics.length) return '';
  return `<div class="topic-tags">${topics.map(t=>
    `<span class="topic-tag ${t}">${TOPICS[t]?TOPICS[t].icon+' '+TOPICS[t].label:t}</span>`
  ).join('')}</div>`;
}

function setViewMode(mode) {
  viewMode=mode;
  document.getElementById('mode-region').classList.toggle('active',mode==='region');
  document.getElementById('mode-topic').classList.toggle('active',mode==='topic');
  document.getElementById('topic-panel').style.display=mode==='topic'?'block':'none';
  document.getElementById('region-panel').style.display=mode==='region'?'block':'none';
  if(mode==='region'){activeTopic=null;}
  updateLegend();
  applyFilters();
}

function setTopic(topic) {
  activeTopic=topic;
  document.querySelectorAll('.topic-item').forEach(el=>el.classList.remove('active'));
  document.getElementById(topic?`topic-${topic}`:'topic-all')?.classList.add('active');
  const hdr=document.getElementById('feed-topic-header');
  if(topic&&TOPICS[topic]){hdr.textContent=`${TOPICS[topic].icon} ${TOPICS[topic].label.toUpperCase()}`;hdr.classList.add('visible');}
  else{hdr.classList.remove('visible');}
  applyFilters();
}

function updateLegend() {
  const el=document.getElementById('legend-content');
  if(viewMode==='topic') {
    el.innerHTML=Object.entries(TOPICS).map(([k,t])=>
      `<div class="legend-item"><div class="legend-dot" style="color:${t.color}"></div>${t.icon} ${t.label}</div>`
    ).join('')+`<div class="legend-item"><div class="legend-dot" style="color:#44ff88"></div> OSINT Tweet</div>`;
  } else {
    el.innerHTML=`
      <div class="legend-item"><div class="legend-dot" style="color:var(--breaking)"></div> Breaking / Urgent</div>
      <div class="legend-item"><div class="legend-dot" style="color:var(--conflict)"></div> Conflict / Military</div>
      <div class="legend-item"><div class="legend-dot" style="color:var(--disaster)"></div> Disaster / Crisis</div>
      <div class="legend-item"><div class="legend-dot" style="color:var(--politics)"></div> Politics / Protest</div>
      <div class="legend-item"><div class="legend-dot" style="color:var(--general)"></div> General News</div>
      <div class="legend-item"><div class="legend-dot" style="color:#44ff88"></div> OSINT Tweet</div>`;
  }
}

function getFilteredEvents() {
  return allEvents.filter(e=>{
    if(!e.lat||!e.lon) return false;
    if(viewMode==='topic'&&activeTopic&&!(e.topics||[]).includes(activeTopic)) return false;
    if(viewMode==='region'){
      const cat=document.getElementById('filter-category').value;
      const sev=parseInt(document.getElementById('filter-severity').value);
      if(cat&&e.category!==cat) return false;
      if((e.severity||1)<sev) return false;
      if(breakingOnly&&!e.is_breaking) return false;
    }
    return true;
  });
}

function updateTopicCounts() {
  const counts={all:allEvents.length};
  Object.keys(TOPICS).forEach(k=>counts[k]=0);
  allEvents.forEach(e=>(e.topics||[]).forEach(t=>{if(counts[t]!==undefined)counts[t]++;}));
  document.getElementById('tcount-all').textContent=counts.all;
  Object.keys(TOPICS).forEach(k=>{
    const el=document.getElementById(`tcount-${k}`);
    if(el) el.textContent=counts[k]||0;
  });
}

function applyFilters() {
  updateTopicCounts();
  renderEventMarkers(getFilteredEvents());
  renderFeed();
}

function toggleBreaking() {
  breakingOnly=!breakingOnly;
  document.getElementById('breaking-toggle').classList.toggle('on',breakingOnly);
  applyFilters();
}

function renderEventMarkers(events) {
  eventLayer.clearLayers();
  events.forEach(e=>{
    const color=markerColor(e);
    const r=5+(e.severity||1)*3;
    const m=L.circleMarker([e.lat,e.lon],{radius:r,color,fillColor:color,fillOpacity:.35,weight:e.is_breaking?2:1,opacity:e.is_breaking?1:.8});
    const cat=e.category||'general';
    const media=e.media_urls?.length?`<div class="popup-media"><img src="${e.media_urls[0]}" onerror="this.style.display='none'"/></div>`:'';
    m.bindPopup(`
      <div class="popup-content">
        <div class="popup-source"><span>${e.source||'Unknown'}</span><span class="popup-category ${cat}">${cat.toUpperCase()}</span></div>
        ${e.is_breaking?'<div class="breaking-badge">‚óâ BREAKING</div>':''}
        <div class="popup-title">${e.title}</div>
        ${topicTagsHtml(e.topics)}
        <div class="popup-summary">${e.summary||''}</div>
        ${media}
        <div class="popup-footer">
          <span class="popup-time">${timeAgo(e.published_at)}</span>
          ${e.url?`<a class="popup-link" href="${e.url}" target="_blank">‚Üí READ MORE</a>`:''}
        </div>
      </div>`,{maxWidth:340});
    eventLayer.addLayer(m);
  });
}

function renderTweetMarkers(tweets) {
  tweetLayer.clearLayers();
  tweets.filter(t=>t.lat&&t.lon).forEach(t=>{
    const m=L.circleMarker([t.lat,t.lon],{radius:5,color:'#44ff88',fillColor:'#44ff88',fillOpacity:.5,weight:1,dashArray:'3,3'});
    const media=t.media_urls?.length?`<div class="tweet-media"><img src="${t.media_urls[0]}" onerror="this.style.display='none'"/></div>`:'';
    m.bindPopup(`
      <div class="popup-content">
        <div class="popup-source"><span class="tweet-handle">@${t.account}</span><span style="font-size:9px;color:var(--text-dim)">${(t.source_method||'').toUpperCase()}</span></div>
        ${topicTagsHtml(t.topics)}
        <div class="popup-title" style="font-size:12px">${t.text}</div>
        ${media}
        <div class="popup-footer"><span class="popup-time">${timeAgo(t.published_at)}</span><a class="popup-link" href="${t.url}" target="_blank">‚Üí VIEW</a></div>
      </div>`);
    tweetLayer.addLayer(m);
  });
}

function renderFeed() {
  const list=document.getElementById('feed-list');
  const count=document.getElementById('feed-count');
  if(activeTab==='news'){
    const filtered=getFilteredEvents().slice(0,100);
    count.textContent=`${filtered.length} events`;
    if(!filtered.length){list.innerHTML='<div class="empty-state">NO EVENTS IN WINDOW</div>';return;}
    list.innerHTML=filtered.map(e=>`
      <div class="feed-item ${e.is_breaking?'breaking-item':''}" onclick="flyTo(${e.lat},${e.lon})">
        <div class="feed-item-source"><span>${e.source}</span><span>${timeAgo(e.published_at)}</span></div>
        <div class="feed-item-title">${e.title}</div>
        <div class="feed-item-meta">
          <span class="cat-tag ${e.category||'general'}">${(e.category||'general').toUpperCase()}</span>
          ${(e.topics||[]).slice(0,2).map(t=>TOPICS[t]?`<span style="font-size:12px" title="${TOPICS[t].label}">${TOPICS[t].icon}</span>`:'').join('')}
          <div class="sev-dots">${[1,2,3,4,5].map(i=>`<div class="sev-dot ${i<=(e.severity||1)?'filled':''}"></div>`).join('')}</div>
          ${e.is_breaking?'<span style="font-family:var(--font-mono);font-size:9px;color:var(--breaking)">‚óâ BREAKING</span>':''}
        </div>
      </div>`).join('');
  } else {
    const src=selectedAccount?allTweets.filter(t=>t.account===selectedAccount):allTweets;
    const filtered=src.slice(0,100);
    count.textContent=`${filtered.length} tweets`;
    if(!filtered.length){list.innerHTML='<div class="empty-state">NO OSINT TWEETS LOADED</div>';return;}
    list.innerHTML=filtered.map(t=>`
      <div class="feed-item" onclick="flyTo(${t.lat},${t.lon})">
        <div class="feed-item-source"><span class="tweet-handle">@${t.account}</span><span>${timeAgo(t.published_at)}</span></div>
        <div class="tweet-text">${t.text}</div>
        ${(t.topics||[]).length?`<div style="margin-top:4px">${(t.topics||[]).map(tp=>TOPICS[tp]?`<span style="font-size:10px;color:${TOPICS[tp].color};margin-right:6px">${TOPICS[tp].icon} ${TOPICS[tp].label}</span>`:'').join('')}</div>`:''}
        ${t.media_urls?.length?`<div class="tweet-media"><img src="${t.media_urls[0]}" onerror="this.style.display='none'"/></div>`:''}
      </div>`).join('');
  }
}

function flyTo(lat,lon){if(lat&&lon)map.flyTo([lat,lon],6,{duration:1});}

function switchTab(tab){
  activeTab=tab;
  document.getElementById('tab-news').classList.toggle('active',tab==='news');
  document.getElementById('tab-osint').classList.toggle('active',tab==='osint');
  renderFeed();
}

function renderAccounts(accounts){
  window._accts=accounts;
  const list=document.getElementById('accounts-list');
  if(!accounts.length){list.innerHTML='<div class="empty-state">NO ACCOUNTS</div>';return;}
  list.innerHTML=accounts.map(a=>`
    <div class="account-item ${selectedAccount===a.handle?'active':''}" onclick="filterAccount('${a.handle}')">
      <span class="account-handle">@${a.handle}</span>
      <span class="account-count">${a.tweet_count}</span>
    </div>`).join('');
}

function filterAccount(handle){
  selectedAccount=selectedAccount===handle?null:handle;
  renderAccounts(window._accts||[]);
  if(selectedAccount) switchTab('osint');
  renderFeed();
}

async function fetchData(){
  const hours=document.getElementById('filter-hours').value;
  try{
    const[evtRes,tweetRes,acctRes,statsRes]=await Promise.all([
      fetch(`${API_BASE}/api/events?hours=${hours}`).then(r=>r.json()).catch(()=>({events:[]})),
      fetch(`${API_BASE}/api/tweets?hours=${hours}`).then(r=>r.json()).catch(()=>({tweets:[]})),
      fetch(`${API_BASE}/api/accounts`).then(r=>r.json()).catch(()=>({accounts:[]})),
      fetch(`${API_BASE}/api/stats`).then(r=>r.json()).catch(()=>({})),
    ]);
    allEvents=evtRes.events||[];
    allTweets=tweetRes.tweets||[];
    document.getElementById('stat-events').textContent=statsRes.total_events||allEvents.length;
    document.getElementById('stat-breaking').textContent=statsRes.breaking_count||0;
    document.getElementById('stat-tweets').textContent=statsRes.total_tweets||allTweets.length;
    updateTopicCounts();
    renderEventMarkers(getFilteredEvents());
    renderTweetMarkers(allTweets);
    renderFeed();
    renderAccounts(acctRes.accounts||[]);
  }catch(err){loadDemoData();}
}

async function triggerRefresh(){
  const btn=document.querySelector('.refresh-btn');
  btn.textContent='‚Üª REFRESHING...';btn.disabled=true;
  try{
    await fetch(`${API_BASE}/api/refresh`,{method:'POST'}).catch(()=>{});
    await new Promise(r=>setTimeout(r,2000));
    await fetchData();
  }finally{btn.textContent='‚Üª REFRESH';btn.disabled=false;}
}

function loadDemoData(){
  const now=new Date().toISOString();
  allEvents=[
    {id:'d1',title:'‚ö† DEMO MODE ‚Äî Backend not connected',summary:'Configure API_BASE and start backend. See README.',lat:40.7,lon:-74,source:'SYSTEM',category:'breaking',topics:[],severity:5,is_breaking:true,published_at:now,url:'',media_urls:[]},
    {id:'d2',title:'Missile barrage targets infrastructure',summary:'Multiple strikes along front line. Casualties reported.',lat:48.5,lon:35.5,source:'Reuters (demo)',category:'conflict',topics:['war'],severity:4,is_breaking:true,published_at:now,url:'',media_urls:[]},
    {id:'d3',title:'Church attacked ‚Äî pastor detained, congregation dispersed',summary:'Diocese confirms arrests. Third incident this month.',lat:9.0,lon:7.5,source:'MorningStar (demo)',category:'conflict',topics:['christian_persecution'],severity:3,is_breaking:false,published_at:now,url:'',media_urls:[]},
    {id:'d4',title:'Suicide bombing kills 12 at crowded market',summary:'Group claims responsibility. Security forces seal area.',lat:33.7,lon:73.1,source:'AP (demo)',category:'conflict',topics:['terrorism'],severity:5,is_breaking:true,published_at:now,url:'',media_urls:[]},
    {id:'d5',title:'Earthquake 6.4M ‚Äî tsunami warning issued',summary:'Residents urged to move to higher ground immediately.',lat:35.6,lon:139.7,source:'USGS (demo)',category:'disaster',topics:['natural_disasters'],severity:4,is_breaking:true,published_at:now,url:'',media_urls:[]},
    {id:'d6',title:'Thousands march against government ‚Äî tear gas deployed',summary:'Police arrest 80 as crowds refuse to disperse.',lat:51.5,lon:-0.1,source:'Guardian (demo)',category:'politics',topics:['protests'],severity:2,is_breaking:false,published_at:now,url:'',media_urls:[]},
    {id:'d7',title:'Wildfires spread across southern region, towns evacuated',summary:'Emergency services stretched. Air quality dangerous.',lat:-33.8,lon:151.0,source:'ABC (demo)',category:'disaster',topics:['natural_disasters'],severity:3,is_breaking:false,published_at:now,url:'',media_urls:[]},
  ];
  allTweets=[];
  document.getElementById('stat-events').textContent=allEvents.length;
  document.getElementById('stat-breaking').textContent=allEvents.filter(e=>e.is_breaking).length;
  document.getElementById('stat-tweets').textContent=0;
  updateTopicCounts();
  renderEventMarkers(getFilteredEvents());
  renderFeed();
  renderAccounts([]);
}

function updateClock(){document.getElementById('clock').textContent=new Date().toUTCString().split(' ').slice(1,5).join(' ')+' UTC';}
setInterval(updateClock,1000);updateClock();
setInterval(fetchData,120000);

window.addEventListener('DOMContentLoaded',async()=>{
  initMap();
  updateLegend();
  document.getElementById('loading-status').textContent='INITIALIZING MAP ENGINE...';
  await new Promise(r=>setTimeout(r,600));
  document.getElementById('loading-status').textContent='FETCHING INTELLIGENCE FEEDS...';
  await fetchData();
  document.getElementById('loading-status').textContent='READY';
  await new Promise(r=>setTimeout(r,400));
  document.getElementById('loading').classList.add('hidden');
});
</script>
</body>
</html>
